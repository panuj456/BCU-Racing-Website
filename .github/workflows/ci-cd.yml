name: CI/CD Pipeline for Full Stack (FastAPI + Static Frontend)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # Backend job: FastAPI, Uvicorn, Pandas, MariaDB
  backend:
    runs-on: ubuntu-latest
    needs: frontend  # Optional: Only if you want to ensure frontend deploy happens before backend

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.10'

      - name: Install dependencies (Backend)
        working-directory: ./backend
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip  # Upgrade pip to avoid any issues
          pip install -r requirements.txt  # Install backend dependencies

      - name: Install FastAPI and Uvicorn
        working-directory: ./backend
        run: |
          source venv/bin/activate
          pip install fastapi uvicorn  # Install FastAPI and Uvicorn explicitly

      - name: Run backend tests
        working-directory: ./backend
        run: |
          source venv/bin/activate
          pytest tests/  # Run your test command (make sure pytest is in requirements.txt)

      - name: Deploy FastAPI Backend to Heroku
        if: success()  # Only deploy if tests pass
        working-directory: ./backend
        run: |
          git remote add heroku https://git.heroku.com/${{ secrets.HEROKU_APP_NAME }}.git
          git push heroku main  # Deploy to Heroku

  # Frontend job: Static files (HTML/CSS/JS)
  frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Install dependencies (Frontend)
        working-directory: ./frontend
        run: |
          npm install  # Install frontend dependencies if needed (even for static sites)

      - name: Build Frontend (Optional)
        working-directory: ./frontend
        run: |
          echo "No build needed for plain HTML/CSS/JS"  # For simple static sites, you can skip the build

      - name: Deploy to Vercel
        if: success()  # Only deploy if all previous steps succeed
        run: |
          curl -s https://vercel.com/download | bash  # Install Vercel CLI
          vercel login ${{ secrets.VERCEL_TOKEN }}  # Login to Vercel with the secret token
          vercel --prod --confirm  # Deploy to Vercel (ensure VERCEL_TOKEN is set in secrets)

  # Optional: DB migrations (MariaDB setup)
  db:
    runs-on: ubuntu-latest
    needs: backend  # Ensure backend setup happens first

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Install MariaDB Client
        run: sudo apt-get install mariadb-client  # Install MariaDB client if needed for migrations

      - name: Run DB Migrations (if any)
        working-directory: ./backend
        run: |
          source venv/bin/activate
          alembic upgrade head  # Run migrations using Alembic (or any other migration tool you're using)
